# 5、传输层

![image](assets/image-20230606203900-o1b3gib.png)

协议是水平的，服务是垂直的，运输层充当的是应用进程之间的逻辑通信，简单来看，传输层接收来自应用层的报文，然后运输层“好像”水平的传输给了对方的传输层，实际上这两个运输层之间并没有一条水平方向的物理连接，传输的数据要向下交付，最终以某种信号在物理链路上传输，传输层屏蔽了这些的实现细节，使高层的应用看起来好像就是传输层实体之间搭建了一条逻辑信道。

---

# 运输层概念

运输层介于网络层和应用层之间，向上提供通信服务，属于面向通信的最高层，但同时也是用户功能的最低层，处在网络边缘的两台主机使用网络核心部分的功能进行端到端通信的时候，都要使用协议栈中的运输层，而网络核心部分的路由器在转发分组时只用到下三层的功能

## 进程之间的通信

* 网络层

  网络层为主机之间的通信提供服务，通过目的IP地址即可向目的主机发送数据，但是发送过去的数据仍然处在网络层
* 传输层

  传输层在网络层的基础上，为应用程序之间的通信提供服务，通信的两端应该是两个应用进程

  * 传输层提供应用间的通信服务
  * 传输层还要对接收到的报文提供差错检测
  * 根据应用的不同需要，传输层还应该有两种传输协议

    * 面向连接的TCP

      实现可靠传输，相当于一条全双工的可靠信道，特点如下：

      1. 提供面向连接的服务
      2. 数据传输之前必须要建立连接，数据传输结束后要释放连接
      3. 不提供广播和多播服务
      4. 实现开销大，占用资源多

    * 无连接的UDP

      不可靠信道

      1. 传输数据之前不需要建立连接
      2. 提供不可靠交付
      3. 简单，开销小
    * 流控制传输协议SCTP
  * 运输层还应该要屏蔽运输层以下的网络核心细节

## 端口

### 复用与分用

传输层实现了复用和分用的功能

1. 复用

    应用层所有的应用程序都可以通过**传输层**再传送到网络层

    （多用一）
2. 分用

    运输层从IP收到发送给各应用进程的数据后，必须分别交付指明的各应用程序

    （一转多）

### 协议端口

![6b0b0d17121fc7870bbb9cb9a602cf2](assets/6b0b0d17121fc7870bbb9cb9a602cf2-20230604200425-1vkiere.png)

那么现在的问题就是，解决如何将对应的数据交付给对应的进程，学习过操作系统后我们知道，应用是有多种状态的，异步性使得进程是“不可预知的”，所以我们不能像网络层中指明目的主机IP地址那样，指明接收机的某个进程，所以我们设置了“端口”，端口是通信的抽象终点

当应用层要发送数据的时候，应用程序就将数据发送到合适的端口，然后运输层从该端口读取数据

当运输层收到对方主机发来的数据之后，就将数据发送到合适的端口，应用程序就从这些端口读取数据

运输层的端口分为

* 服务器使用的端口号

  因为服务器的端口号必须得是固定的，如果是动态的会造成很多麻烦，导致互联网上的其他应用就无法与他进行通信，如上图所示
* 客户端使用的端口号

  客户端的端口号就是客户进程运行的时候才动态选择的，也叫做短暂端口号，建立通信的时候，由客户端程序发起，当服务器进程收到客户进程的报文的时候，就知道了客户进程的端口号，才能和客户进程进行通信，通信结束后，客户进程释放端口，系统回收端口，然后分配给下一个需要使用的进程

# UDP

## 概述

​![image](assets/image-20230606212004-ew0obd9.png)​

UDP是无连接的，不可靠的传输，他只是再IP数据服务上增加了一点内容——分用和复用以及差错检测

* 无连接的
* 尽最大努力交付的
* 面向报文的

  UDP将应用层交付下来的报文，直接把整个报文加上UDP首部后送入IP层，接收的时候也是这样，即UDP一次交付一个完整的报文
* 没有拥塞控制
* 支持一对一、一对多、多对一、多对多通信
* 首部开销很小

  首部仅有8个字节

## 首部格式

UDP数据报由两个字段组成：数据字段和首部字段

首部字段：

每个字段都是两个字节

* 源端口
* 目的端口

  接收方UDP发现收到的报文中的目的端口不正确，则丢弃报文，并由网际控制报文协议ICMP发送“端口不可达”的差错报文给对方

  ​![82603195fa3ac1e719ee2824e9900fd](assets/82603195fa3ac1e719ee2824e9900fd-20230605085851-5ne84ph.jpg)​
* 长度
* 校验和

  “伪首部”是为了计算校验和而临时添加到UDP数据报前面的

# TCP

## TCP的特点

1. 面向连接的传输层协议

    TCP把连接作为最基本的抽象
2. 每一条TCP连接只能有两个端点，也就是点对点的连接

    TCP的端点是什么呢?——**套接字**或**插口**

    也就是将IP地址与端口号进行拼接

    $$
    套接字socket=(IP地址:端口号)
    $$

    每一条TCP连接**唯一的**被通信两端的两个端点（也就是套接字对）所确定

    $$
    TCP连接::=\left\{ socket_1 ,socket_2 \right\}=\left\{ (IP_1:port_1),(IP_2:port_2) \right\}
    $$

    一个IP允许有多个不同的TCP连接，同一个端口号也可以出现在多个不同的TCP连接中
3. TCP提供可靠交付功能
4. TCP提供全双工通信
5. 面向字节流

## 可靠传输的原理是什么

理想的传输条件：

1. 传输信道不产生差错
2. 不管发送方以以多快的速度发送数据，接收方总是来得及处理数据

虽然理想的传输条件不可能被现实中的网络所具备，但是我们可以采取一些传输协议来进行控制，对于出现的错误就重传出错的数据，对于传输的速度进行适当调控以能够使接收方来得及处理数据

### 停止—等待协议

‍

### 连续ARQ协议

## TCP可靠传输的实现

## TCP的流量控制

## TCP的拥塞控制

## TCP的运输连接管理

‍

# 作业题
